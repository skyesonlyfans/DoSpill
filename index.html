<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#5856d6"/>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DoSpill">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/5856d6/FFFFFF?text=DS">

    <title>DoSpill by Skye &lt;3</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/styles/main.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="root">
        <div class="loading-container">
            <h1 class="auth-logo">Do<span>Spill</span></h1>
            <p>Initializing...</p>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop" style="display: none;">
        <div class="modal-box">
            <h3 id="modal-title">Modal Title</h3>
            <p id="modal-text">Modal text goes here.</p>
            <div id="modal-input-container" style="display: none;">
                <input type="text" id="modal-input" placeholder="Enter value...">
            </div>
            <div id="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">Cancel</button>
                <button id="modal-confirm-btn" class="modal-btn modal-btn-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";

        // This function fetches the config and starts the app
        async function initialize() {
            try {
                // Fetch the configuration from our secure serverless function
                const response = await fetch('/api/get-firebase-config');
                if (!response.ok) {
                    throw new Error('Could not fetch Firebase config.');
                }
                const firebaseConfig = await response.json();

                // Initialize Firebase with the fetched config
                initializeApp(firebaseConfig);

                // Now that Firebase is initialized, load the main app logic
                const appModule = await import('/js/app.js');
                // If app.js has a default export that needs to be run, you can call it here.
                // Assuming app.js runs on import due to DOMContentLoaded listener.

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('root').innerHTML = `
                    <div class="loading-container">
                        <h1 class="auth-logo">Do<span>Spill</span></h1>
                        <p style="color: #ff3b30;">Error: Could not connect to services.</p>
                    </div>
                `;
            }
        }

        initialize();
    </script>

    <script>
        // Register Service Worker with robust error handling and retry logic
        if ('serviceWorker' in navigator) {
            let registrationAttempts = 0;
            const maxAttempts = 3;
            let registrationPromise = null; // Singleton pattern to prevent multiple registrations
            
            async function registerServiceWorker() {
                // If registration is already in progress, wait for it
                if (registrationPromise) {
                    console.log('Service worker registration already in progress, waiting...');
                    return registrationPromise;
                }
                
                registrationPromise = performRegistration();
                return registrationPromise;
            }
            
            async function performRegistration() {
                registrationAttempts++;
                console.log(`ServiceWorker registration attempt ${registrationAttempts}/${maxAttempts}`);
                
                try {
                    console.log('Starting service worker registration process...');
                    
                    // First, check if we already have a registration
                    console.log('Checking for existing registrations...');
                    const existingRegistration = await navigator.serviceWorker.getRegistration('/');
                    if (existingRegistration) {
                        console.log('Found existing service worker registration:', existingRegistration);
                        console.log('Active worker:', existingRegistration.active);
                        console.log('Installing worker:', existingRegistration.installing);
                        console.log('Waiting worker:', existingRegistration.waiting);
                        
                        // Check if it's the same script
                        if (existingRegistration.active && existingRegistration.active.scriptURL.includes('service-worker-simple.js')) {
                            console.log('Service worker already registered and active');
                            setupServiceWorkerListeners(existingRegistration);
                            return;
                        } else {
                            // Unregister if it's a different script
                            console.log('Unregistering old service worker:', existingRegistration.active?.scriptURL);
                            await existingRegistration.unregister();
                            console.log('Old service worker unregistered');
                            // Wait a bit for cleanup
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    } else {
                        console.log('No existing service worker registration found');
                    }
                    
                    // Register the new service worker
                    console.log('Registering new service worker');
                    const registration = await navigator.serviceWorker.register('/service-worker-simple.js', {
                        scope: '/',
                        updateViaCache: 'none' // Always check for updates
                    });
                    
                    console.log('ServiceWorker registration successful with scope:', registration.scope);
                    setupServiceWorkerListeners(registration);
                    
                } catch (error) {
                    console.warn(`ServiceWorker registration attempt ${registrationAttempts} failed:`, error);
                    
                    // Reset the promise so we can retry
                    registrationPromise = null;
                    
                    // Retry with exponential backoff
                    if (registrationAttempts < maxAttempts) {
                        const delay = Math.pow(2, registrationAttempts) * 1000; // 2s, 4s, 8s
                        console.log(`Retrying service worker registration in ${delay}ms`);
                        setTimeout(() => {
                            registerServiceWorker();
                        }, delay);
                    } else {
                        console.error('ServiceWorker registration failed after all attempts. App will work without offline capabilities.');
                    }
                    throw error; // Re-throw for the promise chain
                }
            }
            
            function setupServiceWorkerListeners(registration) {
                // Handle updates
                registration.addEventListener('updatefound', () => {
                    console.log('Service worker update found');
                    const newWorker = registration.installing;
                    if (newWorker) {
                        newWorker.addEventListener('statechange', () => {
                            console.log('Service worker state changed to:', newWorker.state);
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New service worker installed, will be active on next page load');
                                // Optionally show update notification to user
                                showUpdateNotification();
                            }
                        });
                    }
                });
                
                // Handle controller change
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Service worker controller changed');
                    // Optionally reload the page to use the new service worker
                });
            }
            
            function showUpdateNotification() {
                // Simple update notification (you can make this more sophisticated)
                if (window.confirm('A new version of DoSpill is available. Reload to update?')) {
                    window.location.reload();
                }
            }
            
            // Start registration when page loads and is stable
            function startRegistration() {
                // Add a small delay to ensure the page is fully stable
                setTimeout(() => {
                    registerServiceWorker().catch(error => {
                        console.error('Final service worker registration failed:', error);
                    });
                }, 100);
            }
            
            if (document.readyState === 'loading') {
                window.addEventListener('load', startRegistration);
            } else {
                // Page already loaded
                startRegistration();
            }
            
            // Listen for service worker messages
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('Message from service worker:', event.data);
                
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    showUpdateNotification();
                }
            });
            
            // Handle page visibility changes to check for updates
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // Page became visible, check for service worker updates
                    navigator.serviceWorker.getRegistration('/').then(registration => {
                        if (registration) {
                            registration.update();
                        }
                    });
                }
            });
            
        } else {
            console.log('Service workers are not supported in this browser');
        }
    </script>
</body>
</html>